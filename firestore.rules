rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ---------- HELPERS ---------- */

    function isSignedIn() {
      return request.auth != null;
    }

    function getUserData() {
      // Use getAfter if available for multi-step transactions, but here get is fine.
      // We use a safe path to avoid crashing on missing docs.
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function hasRole(targetRole) {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
             getUserData().role == targetRole;
    }

    function isAdmin() {
      return hasRole('admin');
    }

    function isTeacher() {
      return hasRole('teacher');
    }

    function isParent() {
      return hasRole('parent');
    }

    function getSchoolId() {
      // Robust retrieval of schoolId
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)) 
             ? getUserData().schoolId 
             : null;
    }

    /* ---------- USERS ---------- */
    match /users/{uid} {
      allow read, create, update: if isSignedIn() && request.auth.uid == uid;
      allow delete: if false;
    }

    /* ---------- SCHOOLS ---------- */
    match /schools/{schoolId} {
      allow read: if isSignedIn();

      // âœ… SCHOOL CREATION (Race-Condition Proof)
      // We allow school creation if the UID matches. 
      // The role 'admin' is set in the same frontend operation.
      allow create: if isSignedIn() 
        && request.resource.data.adminUid == request.auth.uid;

      // Management remains strict
      allow update, delete: if isSignedIn() 
        && isAdmin() 
        && resource.data.adminUid == request.auth.uid;
    }

    /* ---------- CLASSES ---------- */
    match /classes/{classId} {
      allow create, delete: if isSignedIn() && isAdmin() && request.resource.data.schoolId == getSchoolId();
      
      allow update: if isSignedIn() && (
        (isAdmin() && request.resource.data.schoolId == getSchoolId()) ||
        (isTeacher() && resource.data.classTeacherId == request.auth.uid)
      );

      allow read: if isSignedIn() && (resource == null || resource.data.schoolId == getSchoolId());
    }

    /* ---------- STUDENTS ---------- */
    match /students/{studentId} {
      allow create, delete: if isSignedIn() && isAdmin() && request.resource.data.schoolId == getSchoolId();
      
      allow update: if isSignedIn() && (
        (isAdmin() && request.resource.data.schoolId == getSchoolId()) ||
        (isParent() && resource.data.parentUid == request.auth.uid)
      );

      allow read: if isSignedIn() && (
        (isAdmin() && (resource == null || resource.data.schoolId == getSchoolId())) ||
        (isTeacher() && (resource == null || resource.data.schoolId == getSchoolId())) ||
        (isParent() && (resource == null || resource.data.parentEmail == request.auth.token.email))
      );
    }

    /* ---------- ACADEMIC DATA ---------- */
    match /syllabus/{id} {
      allow read: if isSignedIn() && (resource == null || resource.data.schoolId == getSchoolId());
      allow write: if isSignedIn() && (isAdmin() || isTeacher()) && request.resource.data.schoolId == getSchoolId();
    }

    match /weeklyUpdates/{id} {
      allow read: if isSignedIn() && (resource == null || resource.data.schoolId == getSchoolId());
      allow write: if isSignedIn() && isTeacher() && request.resource.data.schoolId == getSchoolId();
    }

    match /announcements/{id} {
      allow read: if isSignedIn() && (resource == null || resource.data.schoolId == getSchoolId());
      allow write: if isSignedIn() && (isAdmin() || isTeacher()) && request.resource.data.schoolId == getSchoolId();
    }

    match /aiContent/{id} {
        allow read, write: if isSignedIn() && isTeacher();
    }

    /* ---------- DEFAULT DENY ---------- */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
