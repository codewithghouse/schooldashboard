rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function userDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function role() {
      return userDoc().data.role;
    }

    function userSchoolId() {
      return userDoc().data.schoolId;
    }

    function isAdmin() {
      return role() == "admin";
    }

    function isTeacher() {
      return role() == "teacher";
    }

    function isParent() {
      return role() == "parent";
    }

    /* ---------- USERS ---------- */
    match /users/{uid} {
      allow read: if isSignedIn() && request.auth.uid == uid;
      allow create: if isSignedIn() && request.auth.uid == uid;
      // Admin linking their schoolId or Teacher/Parent linking their UID
      allow update: if isSignedIn() && request.auth.uid == uid;
      allow delete: if false;
    }

    /* ---------- SCHOOLS ---------- */
    match /schools/{schoolId} {

      // âœ… FIRST SCHOOL CREATE (ONBOARDING EXCEPTION)
      allow create: if isSignedIn()
        && isAdmin()
        && userDoc().data.schoolId == null;

      // Admin can manage only their school after linking
      allow read, update, delete: if isSignedIn()
        && isAdmin()
        && resource.data.adminUid == request.auth.uid;
    }

    /* ---------- CLASSES ---------- */
    match /classes/{classId} {

      // Admin creates & deletes classes
      allow create, delete: if isSignedIn()
        && isAdmin()
        && request.resource.data.schoolId == userSchoolId();

      // Admin full update OR teacher updating their own class
      allow update: if isSignedIn() && (
        (isAdmin() && request.resource.data.schoolId == userSchoolId()) ||
        (isTeacher() && resource.data.classTeacherId == request.auth.uid)
      );

      // Admin & Teacher can read classes of their school
      allow read: if isSignedIn()
        && resource.data.schoolId == userSchoolId();
    }

    /* ---------- STUDENTS ---------- */
    match /students/{studentId} {

      // Only admin can create/delete students
      allow create, delete: if isSignedIn()
        && isAdmin()
        && request.resource.data.schoolId == userSchoolId();

      // Admin can update student data
      allow update: if isSignedIn()
        && isAdmin()
        && request.resource.data.schoolId == userSchoolId();

      // Read rules
      allow read: if isSignedIn() && (
        (isAdmin() && resource.data.schoolId == userSchoolId()) ||
        (isTeacher() && resource.data.schoolId == userSchoolId()) ||
        (isParent() && resource.data.parentEmail == request.auth.token.email)
      );
    }

    /* ---------- SYLLABUS ---------- */
    match /syllabus/{id} {
      allow read: if isSignedIn()
        && resource.data.schoolId == userSchoolId();

      allow create, update, delete: if isSignedIn()
        && (isAdmin() || isTeacher())
        && request.resource.data.schoolId == userSchoolId();
    }

    /* ---------- WEEKLY UPDATES ---------- */
    match /weeklyUpdates/{id} {
      allow read: if isSignedIn()
        && resource.data.schoolId == userSchoolId();

      allow create, update, delete: if isSignedIn()
        && isTeacher()
        && request.resource.data.schoolId == userSchoolId();
    }

    /* ---------- ANNOUNCEMENTS ---------- */
    match /announcements/{id} {
      allow read: if isSignedIn()
        && resource.data.schoolId == userSchoolId();

      allow create, update, delete: if isSignedIn()
        && (isAdmin() || isTeacher())
        && request.resource.data.schoolId == userSchoolId();
    }

    /* ---------- DEFAULT DENY ---------- */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
