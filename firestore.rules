rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // --- Users Collection ---
    match /users/{uid} {
      allow read: if request.auth.uid == uid;
      allow create: if isAuthenticated(); // Allow during /accept-invite
      allow update: if request.auth.uid == uid;
    }

    // --- Schools Collection ---
    match /schools/{schoolId} {
      allow read: if isAuthenticated() && getUserData().schoolId == schoolId;
      allow write: if isAuthenticated() && getUserData().role == 'school_admin';
    }

    // --- Classes Collection ---
    match /classes/{classId} {
      // Admin: All in school. Teacher: only assigned.
      allow read: if isAuthenticated() && (
        getUserData().role == 'school_admin' || 
        (getUserData().role == 'teacher' && resource.data.classTeacherId == request.auth.uid)
      );
      allow write: if isAuthenticated() && (
        getUserData().role == 'school_admin' ||
        (getUserData().role == 'teacher' && resource.data.classTeacherId == request.auth.uid)
      );
    }

    // --- Students Collection ---
    match /students/{studentId} {
      // Admin: All in school. Teacher: only in their classes. Parent: only their children.
      allow read: if isAuthenticated() && (
        getUserData().role == 'school_admin' ||
        (getUserData().role == 'teacher' && get(/databases/$(database)/documents/classes/$(resource.data.classId)).data.classTeacherId == request.auth.uid) ||
        (getUserData().role == 'parent' && resource.data.parentEmail == request.auth.token.email)
      );
      allow write: if isAuthenticated() && (
        getUserData().role == 'school_admin' ||
        (getUserData().role == 'teacher' && get(/databases/$(database)/documents/classes/$(resource.data.classId)).data.classTeacherId == request.auth.uid)
      );
    }
    
    // --- Teachers Collection (Convenience profile) ---
    match /teachers/{uid} {
      allow read: if isAuthenticated() && (getUserData().schoolId == resource.data.schoolId);
      allow write: if isAuthenticated() && (request.auth.uid == uid || getUserData().role == 'school_admin');
    }

    // --- Syllabus, Updates, Announcements ---
    match /{path=**}/syllabus/{id} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && (getUserData().role == 'school_admin' || getUserData().role == 'teacher');
    }
    
    match /weeklyUpdates/{id} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && (getUserData().role == 'teacher');
    }

    match /announcements/{id} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && (getUserData().role != 'parent');
    }

    match /aiContent/{id} {
        allow read, write: if isAuthenticated() && getUserData().role == 'teacher';
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
